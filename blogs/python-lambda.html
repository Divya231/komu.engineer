<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Komu W - blog.</title>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ADD FAVICON -->
    <link rel="stylesheet" href="../site.css">

    <!-- Get highlightjs by going to https://highlightjs.org/download/, select the languages you want and download. -->
    <link rel="stylesheet" href="../highlightjs/styles/default.css">
    <script src="../highlightjs/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="https://www.komu.engineer">Home</a>&nbsp;&nbsp;
            <a href="https://www.komu.engineer/about">About Me</a>&nbsp;&nbsp;
            <a href="https://www.komu.engineer/blog">Blog</a>&nbsp;&nbsp;
        </div>
        <div class="left-sidebar">
            .
        </div>
        <div class="right-sidebar">
            .
        </div>

        <div class="main">
            <p>
                <strong>Migrating a python app to AWS lambda as is; without code change.(02 June 2018)</strong>
                </br>
                </br>
                <strong>Intro</strong>
                </br>
                AWS Lambda lets you run code without provisioning or managing servers.</br>
                In this article, we will go through an example of how to migrate a python applicatioon to AWS lambda. </br>
                Of importance to note is that; we will not make any significant code change to our app in order to migrate it.</br>
                You may have heard of Python frameworks that help you write python code targeted for running on AWS lambda. for example;
                <a href="https://github.com/aws/chalice">Chalice</a> or
                <a href="https://github.com/Miserlou/Zappa">Zappa</a>. </br>
                A drawback of those frameworks - in my opinion - is that they require you to change the way you architect your applications.
                </br>
                They require you to make code changes to suit their way of things.</br>
                In this post we wont do any of that, you will keep your familiar architect/code and still get to run your app on lambda.</br>
                </br>

                - We will create a small python/django app from the ground up, using the same old familiar django pattern.</br>
                - We will then run that app on AWS lambda.

                </br>
                </br>
                <strong>Create django app.</strong>
                </br>
                The app we will build is a simple one. It is a website uptime checker.</br>
                It makes a http request to google.com and twitter.com, checks whether they are up or not and reports the same.
                </br>

                We'll create a new directory for our app, create a virtualenv, install django and also create a requirements file with the
                installed packages.
                <pre><code class="bash">
mkdir uptime-checker && \
cd uptime-checker && \
virtualenv .uptime-checker && \
source .uptime-checker/bin/activate && \
pip install django && \
pip freeze >> requirements.txt
                </code></pre> </br>
                Create a
                <i>settings.py</i> file with the following contents:</br>
                <pre><code class="python">
import os

def here(*args):
    return os.path.join(os.path.abspath(os.path.dirname(__file__)), *args)

PROJECT_ROOT = here('')
def project_root_joiner(*args):
    return os.path.join(os.path.abspath(PROJECT_ROOT), *args)

ALLOWED_HOSTS = '*'
SECRET_KEY =  'A-random-and-secure-secret-key'
ROOT_URLCONF = 'urls'
WSGI_APPLICATION = 'wsgi.application'
INSTALLED_APPS = (
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.messages',
    'django.contrib.staticfiles',
)
STATIC_ROOT = project_root_joiner('', 'static/')
STATIC_URL = '/static/'
                </code></pre>
                </br>
                Create a
                <i>wsgi.py</i> file with contents;
                <pre><code class="python">
import os
from django.core.wsgi import get_wsgi_application
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "settings")
application = get_wsgi_application()
                </code></pre>
                </br>
                And
                <i>urls.py</i>;
                <pre><code class="python">
from django.conf.urls import url
import views
urlpatterns = (
    url(r'^$', views.home, name='home'),
)
                </code></pre>
                </br>
                We also need the manage.py file. </br>
                Create
                <i>manage.py</i> file with content;
                <pre><code class="python">
#!/usr/bin/env python
import os
import sys
if __name__ == "__main__":
    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "settings")
    from django.core.management import execute_from_command_line
    execute_from_command_line(sys.argv)          
                </code></pre>
                </br>

                We created urls.py and the code in there is referring to views, but we haven't created views yet.</br>
                So lets do just that, create
                <i>views.py</i> whose content is;
                <pre><code class="python">
from django.http import HttpResponse
def home(request):
    return HttpResponse("Hello. Welcome to Python and AWS lambda.") 
                     </code></pre>
                </br>

                And this been python, we need an empty __init__ file, so create it.</br>
                <pre><code class="bash">
touch __init__.py
                    </code></pre>
                </br>

                So your final directory structure looks like;</br>
                <pre><code class="bash">
uptime-checker/
    __init__.py
    manage.py
    settings.py
    urls.py
    views.py
    wsgi.py
                </code></pre>
                </br>
                But does the app really work? There's only one way to find out; let's run it.
                <pre><code class="bash">
python manage.py runserver 0.0.0.0:8080
                </code></pre>
                </br>
                When you visit
                <i>http://localhost:8080/</i> with your favorite browser, you see that you get the
                <i>Hello. Welcome to Python and AWS lambda.</i> greeting.</br>
                </br>

                We were not making a greetings app, we want a website uptime checker. So lets add the logic in our views to check on the
                uptime of our two websites; google and twitter.</br>
                The modified
                <i>views.py</i> becomes;
                <pre><code class="python">
import urllib
from django.http import HttpResponse
def home(request):
    g = urllib.urlopen("http://www.google.com")
    google_status_code = g.getcode()
    g.close()
    t = urllib.urlopen("http://www.twitter.com")
    twitter_status_code = t.getcode()
    t.close()
    return HttpResponse("""Uptime Checker. google.com status={0}. twitter.com status={1}""".format(
        google_status_code,
        twitter_status_code)) 
                </code></pre>
                </br>
                </br>
                There, our app is working as per spec. It is not pretty or the most useful app, but it is working albeit on our machines.</br>
                What we want to do now is deploy this app - as is - to AWS lambda.

                </br>
                </br>
                <strong>Deploying django app to AWS lambda.</strong>
                </br>
                </br>
                1. First we need to install
                <a href="https://github.com/apex/up">up.</a>
                </br>
                <i>up</i> bills itself thus; </br>
                Up focuses on deploying "vanilla" HTTP servers
                <strong>there's nothing new to learn</strong>, just develop with your favorite existing frameworks such as Express,
                Koa, Django, Golang net/http or others. -- https://github.com/apex/up (emphasis is mine.)</br>
                </br>
                <i>up</i> can be installed via curl;
                <pre><code class="bash">
curl -sf https://up.apex.sh/install | sh
                </code></pre>
                </br>
                You can make sure that
                <i>up</i> has installed succesfully by checking it's help command.
                <pre><code class="bash">
up --help
                </code></pre>
                </br>
                </br>

                2. Next we need to make sure that our AWS setup is ok.</br>
                - make sure that your aws credentials are okay and stored in the
                <a href="https://up.docs.apex.sh/#aws_credentials">right place/s.</a> For my case, I have a
                <i>~/.aws/credentials</i> file that looks like;
                <pre><code class="bash">
[apex-up-profile]
aws_access_key_id = myAccessId
aws_secret_access_key = myAccessKey
region = eu-west-1
                </code></pre>
                </br>
                - also make sure that you create
                <a href="https://up.docs.apex.sh/#aws_credentials.iam_policy_for_up_cli">this AWS policy</a> in your AWS account.</br>
                </br>

                3. In the
                <i>uptime-checker</i> directory, create an
                <i>up.json</i> file whose contents are;
                <pre><code class="bash">
{
  "name": "uptime-checker",
  "profile": "apex-up-profile"
}
                </code></pre>
                </br>
                where the value of the profile json key is the same as the profile name in your aws config(
                <i>~/.aws/credentials</i> for my case)</br>
                </br>

                4. to deploy your app to AWS lambda, run the following command;
                <pre><code class="bash">
up deploy
                </code></pre>
                </br>
                You will see an output like;
                <pre><code class="bash">
build: 15 files, 4.4 MB (770ms)
deploy: commit c9fda96 (11.942s)
stack: complete (47.398s)
                </code></pre>
                </br>
                To see the domain/url that your app was deployed to, run the command;
                <pre><code class="bash">
up url
                </code></pre>
                </br>
                You can copy paste that url to your browser and access your app.

            </p>
        </div>
    </div>
</body>