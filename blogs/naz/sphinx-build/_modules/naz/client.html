
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>naz.client &#8212; naz v0.6.0-beta.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for naz.client</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">q</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">hooks</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">nazcodec</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">sequence</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">throttle</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">correlater</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">ratelimiter</span>

<span class="kn">from</span> <span class="nn">.state</span> <span class="k">import</span> <span class="n">SmppSessionState</span><span class="p">,</span> <span class="n">SmppCommand</span><span class="p">,</span> <span class="n">SmppCommandStatus</span><span class="p">,</span> <span class="n">SmppDataCoding</span><span class="p">,</span> <span class="n">SmppOptionalTag</span>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../client.html#naz.client.Client">[docs]</a><span class="k">class</span> <span class="nc">Client</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The SMPP client that will interact with SMSC/server.</span>

<span class="sd">    Example declaration:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        import os</span>
<span class="sd">        import asyncio</span>
<span class="sd">        import naz</span>
<span class="sd">        loop = asyncio.get_event_loop()</span>
<span class="sd">        outboundqueue = naz.q.SimpleOutboundQueue(maxsize=1000, loop=loop)</span>
<span class="sd">        client = naz.Client(</span>
<span class="sd">                async_loop=loop,</span>
<span class="sd">                smsc_host=&quot;127.0.0.1&quot;,</span>
<span class="sd">                smsc_port=2775,</span>
<span class="sd">                system_id=&quot;smppclient1&quot;,</span>
<span class="sd">                password=os.getenv(&quot;password&quot;, &quot;password&quot;),</span>
<span class="sd">                outboundqueue=outboundqueue,</span>
<span class="sd">            )</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Client.__init__"><a class="viewcode-back" href="../../client.html#naz.client.Client.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">async_loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">,</span>
        <span class="n">smsc_host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">smsc_port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">system_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">outboundqueue</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">BaseOutboundQueue</span><span class="p">,</span>
        <span class="n">client_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">system_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">addr_ton</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">addr_npi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">address_range</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gsm0338&quot;</span><span class="p">,</span>
        <span class="n">interface_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
        <span class="n">service_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CMT&quot;</span><span class="p">,</span>  <span class="c1"># section 5.2.11</span>
        <span class="n">source_addr_ton</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>  <span class="c1"># section 5.2.5</span>
        <span class="n">source_addr_npi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>
        <span class="n">dest_addr_ton</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>
        <span class="n">dest_addr_npi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>
        <span class="c1"># xxxxxx00 store-and-forward</span>
        <span class="c1"># xx0010xx Short Message contains ESME Delivery Acknowledgement</span>
        <span class="c1"># 00xxxxxx No specific features selected</span>
        <span class="n">esm_class</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mb">0b00000011</span><span class="p">,</span>  <span class="c1"># section 5.2.12</span>
        <span class="n">protocol_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
        <span class="n">priority_flag</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
        <span class="n">schedule_delivery_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">validity_period</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="c1"># xxxxxx01 SMSC Delivery Receipt requested where final delivery outcome is delivery success or failure</span>
        <span class="c1"># xxxx01xx SME Delivery Acknowledgement requested</span>
        <span class="c1"># xxx0xxxx No Intermediate notification requested</span>
        <span class="c1"># all other values reserved</span>
        <span class="n">registered_delivery</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mb">0b00000001</span><span class="p">,</span>  <span class="c1"># see section 5.2.17</span>
        <span class="n">replace_if_present_flag</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
        <span class="n">sm_default_msg_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
        <span class="n">enquire_link_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">log_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">loglevel</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span>
        <span class="n">log_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">codec_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">codec_errors_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="n">rateLimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sequence_generator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">throttle_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">correlation_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters:</span>
<span class="sd">            async_loop: asyncio event loop.</span>
<span class="sd">            smsc_host:	the IP address(or domain name) of the SMSC gateway/server</span>
<span class="sd">            smsc_port:	the port at which SMSC is listening on</span>
<span class="sd">            system_id:	Identifies the ESME system requesting to bind as a transceiver with the SMSC.</span>
<span class="sd">            password:	The password to be used by the SMSC to authenticate the ESME requesting to bind.</span>
<span class="sd">            system_type:	Identifies the type of ESME system requesting to bind with the SMSC.</span>
<span class="sd">            addr_ton:	Type of Number of the ESME address.</span>
<span class="sd">            addr_npi:	Numbering Plan Indicator (NPI) for ESME address(es) served via this SMPP transceiver session</span>
<span class="sd">            address_range:	A single ESME address or a range of ESME addresses served via this SMPP transceiver session.</span>
<span class="sd">            interface_version:	Indicates the version of the SMPP protocol supported by the ESME.</span>
<span class="sd">            service_type:	Indicates the SMS Application service associated with the message</span>
<span class="sd">            source_addr_ton:	Type of Number of message originator.</span>
<span class="sd">            source_addr_npi:	Numbering Plan Identity of message originator.</span>
<span class="sd">            dest_addr_ton:	Type of Number for destination.</span>
<span class="sd">            dest_addr_npi:	Numbering Plan Identity of destination</span>
<span class="sd">            esm_class:	Indicates Message Mode &amp; Message Type.</span>
<span class="sd">            protocol_id:	Protocol Identifier. Network specific field.</span>
<span class="sd">            priority_flag:	Designates the priority level of the message.</span>
<span class="sd">            schedule_delivery_time:	The short message is to be scheduled by the SMSC for delivery.</span>
<span class="sd">            validity_period:	The validity period of this message.</span>
<span class="sd">            registered_delivery:	Indicator to signify if an SMSC delivery receipt or an SME acknowledgement is required.</span>
<span class="sd">            replace_if_present_flag:	Flag indicating if submitted message should replace an existing message.</span>
<span class="sd">            sm_default_msg_id:	Indicates the short message to send from a list of predefined (‘canned’) short messages stored on the SMSC</span>
<span class="sd">            encoding:	encoding1 used to encode messages been sent to SMSC</span>
<span class="sd">            sequence_generator:	python class instance used to generate sequence_numbers</span>
<span class="sd">            outboundqueue:	python class instance implementing some queueing mechanism. \</span>
<span class="sd">                messages to be sent to SMSC are queued using the said mechanism before been sent</span>
<span class="sd">            client_id:	a unique string identifying a naz client class instance</span>
<span class="sd">            log_handler: python class instance to be used for logging</span>
<span class="sd">            loglevel:	the level at which to log</span>
<span class="sd">            log_metadata: metadata that will be included in all log statements</span>
<span class="sd">            codec_class: python class instance to be used to encode/decode messages</span>
<span class="sd">            codec_errors_level:	same meaning as the errors argument to pythons&#39; encode method as defined here</span>
<span class="sd">            enquire_link_interval:	time in seconds to wait before sending an enquire_link request to SMSC to check on its status</span>
<span class="sd">            rateLimiter: python class instance implementing rate limitation</span>
<span class="sd">            hook: python class instance implemeting functionality/hooks to be called by naz \</span>
<span class="sd">                just before sending request to SMSC and just after getting response from SMSC</span>
<span class="sd">            throttle_handler: python class instance implementing functionality of what todo when naz starts getting throttled responses from SMSC</span>
<span class="sd">            correlation_handler: A python class instance that naz uses to store relations between \</span>
<span class="sd">                SMPP sequence numbers and user applications&#39; log_id&#39;s and/or hook_metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">loglevel</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span> <span class="s2">&quot;WARNING&quot;</span><span class="p">,</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s2">&quot;CRITICAL&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;loglevel should be one of; &#39;DEBUG&#39;, &#39;INFO&#39;, &#39;WARNING&#39;, &#39;ERROR&#39; or &#39;CRITICAL&#39;. not {0}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">loglevel</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_metadata</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;log_metadata should be of type:: None or dict. You entered {0}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">log_metadata</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># this allows people to pass in their own event loop eg uvloop.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">async_loop</span> <span class="o">=</span> <span class="n">async_loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsc_host</span> <span class="o">=</span> <span class="n">smsc_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsc_port</span> <span class="o">=</span> <span class="n">smsc_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_id</span> <span class="o">=</span> <span class="n">system_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outboundqueue</span> <span class="o">=</span> <span class="n">outboundqueue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system_type</span> <span class="o">=</span> <span class="n">system_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface_version</span> <span class="o">=</span> <span class="n">interface_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr_ton</span> <span class="o">=</span> <span class="n">addr_ton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addr_npi</span> <span class="o">=</span> <span class="n">addr_npi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address_range</span> <span class="o">=</span> <span class="n">address_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span> <span class="o">=</span> <span class="n">sequence_generator</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span> <span class="o">=</span> <span class="n">sequence</span><span class="o">.</span><span class="n">SimpleSequenceGenerator</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span> <span class="o">=</span> <span class="mh">0x7FFFFFFF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span> <span class="o">=</span> <span class="n">loglevel</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span> <span class="o">=</span> <span class="n">log_metadata</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;smsc_host&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsc_host</span><span class="p">,</span> <span class="s2">&quot;system_id&quot;</span><span class="p">:</span> <span class="n">system_id</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span> <span class="o">=</span> <span class="n">codec_errors_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span> <span class="o">=</span> <span class="n">codec_class</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span> <span class="o">=</span> <span class="n">nazcodec</span><span class="o">.</span><span class="n">SimpleNazCodec</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service_type</span> <span class="o">=</span> <span class="n">service_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_addr_ton</span> <span class="o">=</span> <span class="n">source_addr_ton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_addr_npi</span> <span class="o">=</span> <span class="n">source_addr_npi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_addr_ton</span> <span class="o">=</span> <span class="n">dest_addr_ton</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest_addr_npi</span> <span class="o">=</span> <span class="n">dest_addr_npi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esm_class</span> <span class="o">=</span> <span class="n">esm_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol_id</span> <span class="o">=</span> <span class="n">protocol_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priority_flag</span> <span class="o">=</span> <span class="n">priority_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_delivery_time</span> <span class="o">=</span> <span class="n">schedule_delivery_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validity_period</span> <span class="o">=</span> <span class="n">validity_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registered_delivery</span> <span class="o">=</span> <span class="n">registered_delivery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_if_present_flag</span> <span class="o">=</span> <span class="n">replace_if_present_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sm_default_msg_id</span> <span class="o">=</span> <span class="n">sm_default_msg_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enquire_link_interval</span> <span class="o">=</span> <span class="n">enquire_link_interval</span>

        <span class="c1"># see section 5.1.2.1 of smpp ver 3.4 spec document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span><span class="p">:</span> <span class="mh">0x00000009</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER_RESP</span><span class="p">:</span> <span class="mh">0x80000009</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND</span><span class="p">:</span> <span class="mh">0x00000006</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND_RESP</span><span class="p">:</span> <span class="mh">0x80000006</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span><span class="p">:</span> <span class="mh">0x00000004</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000004</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM</span><span class="p">:</span> <span class="mh">0x00000005</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM_RESP</span><span class="p">:</span> <span class="mh">0x80000005</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK</span><span class="p">:</span> <span class="mh">0x00000015</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK_RESP</span><span class="p">:</span> <span class="mh">0x80000015</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">GENERIC_NACK</span><span class="p">:</span> <span class="mh">0x80000000</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_coding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_data_coding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># NB: currently, naz only uses to log levels; INFO and EXCEPTION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">log_handler</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">SimpleBaseLogger</span><span class="p">(</span><span class="s2">&quot;naz.client&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">log_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_metadata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sanity_check_logger</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rateLimiter</span> <span class="o">=</span> <span class="n">rateLimiter</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rateLimiter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rateLimiter</span> <span class="o">=</span> <span class="n">ratelimiter</span><span class="o">.</span><span class="n">SimpleRateLimiter</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">hook</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">hooks</span><span class="o">.</span><span class="n">SimpleHook</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span> <span class="o">=</span> <span class="n">throttle_handler</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span> <span class="o">=</span> <span class="n">throttle</span><span class="o">.</span><span class="n">SimpleThrottleHandler</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># class storing SMPP sequence_number and their corresponding log_id and/or hook_metadata</span>
        <span class="c1"># this will be used to track different pdu&#39;s and user generated log_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span> <span class="o">=</span> <span class="n">correlation_handler</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span> <span class="o">=</span> <span class="n">correlater</span><span class="o">.</span><span class="n">SimpleCorrelater</span><span class="p">()</span>

        <span class="c1"># the messages that are published to a queue by either naz</span>
        <span class="c1"># or user application should be versioned.</span>
        <span class="c1"># This version will enable naz to be able to evolve in future;</span>
        <span class="c1"># eg a future version of naz could add/remove the number of required items in a message.</span>
        <span class="c1"># This is a bit similar to: http://docs.celeryproject.org/en/latest/internals/protocol.html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naz_message_protocol_version</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">CLOSED</span></div>

    <span class="k">def</span> <span class="nf">_sanity_check_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        called when instantiating the Client just to make sure the supplied</span>
<span class="sd">        logger can log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;sanity_check_logger&quot;</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">log_data</span><span class="p">):</span>
        <span class="c1"># if the supplied logger is unable to log; we move on</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">log_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_find_data_coding</span><span class="p">(</span><span class="n">encoding</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">SmppDataCoding</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="n">val</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;That encoding:</span><span class="si">{0}</span><span class="s2"> is not recognised.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">encoding</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_search_by_command_id_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_id_code</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">command_id_code</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">key</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_search_by_command_status_value</span><span class="p">(</span><span class="n">command_status_value</span><span class="p">):</span>
        <span class="c1"># TODO: find a cheaper(better) way of doing this</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">command_status_value</span> <span class="o">==</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_retry_after</span><span class="p">(</span><span class="n">current_retries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        retries will happen in this sequence;</span>
<span class="sd">        1min, 2min, 4min, 8min, 16min, 32min, 16min, 16min, 16min ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO:</span>
        <span class="c1"># 1. give users ability to bring their own retry algorithms.</span>
        <span class="c1"># 2. add jitter</span>
        <span class="k">if</span> <span class="n">current_retries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">current_retries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">current_retries</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">16</span>  <span class="c1"># 16 minutes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">60</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">current_retries</span><span class="p">))</span>

<div class="viewcode-block" id="Client.connect"><a class="viewcode-back" href="../../client.html#naz.client.Client.connect">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamReader</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamWriter</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make a network connection to SMSC server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.connect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>
        <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsc_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsc_port</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">async_loop</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamReader</span> <span class="o">=</span> <span class="n">reader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">streams</span><span class="o">.</span><span class="n">StreamWriter</span> <span class="o">=</span> <span class="n">writer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.connect&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">OPEN</span>
        <span class="k">return</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span></div>

<div class="viewcode-block" id="Client.tranceiver_bind"><a class="viewcode-back" href="../../client.html#naz.client.Client.tranceiver_bind">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">tranceiver_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a BIND_RECEIVER pdu to SMSC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">body</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">system_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface_version</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr_ton</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">addr_npi</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="c1"># the status for success see section 5.1.3</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
            <span class="c1"># prevent third party sequence_generators from ruining our party</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># associate sequence_number with log_id.</span>
        <span class="c1"># this will enable us to also associate responses and thus enhancing traceability of all workflows</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>
        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.tranceiver_bind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.enquire_link"><a class="viewcode-back" href="../../client.html#naz.client.Client.enquire_link">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">enquire_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an ENQUIRE_LINK pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TESTING: indicates whether this method is been called while running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">!=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">BOUND_TRX</span><span class="p">:</span>
                <span class="c1"># you can only send enquire_link request when session state is BOUND_TRX</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enquire_link_interval</span><span class="p">)</span>

            <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="c1"># body</span>
            <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

            <span class="c1"># header</span>
            <span class="n">command_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
            <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
            <span class="n">command_status</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># not used for `enquire_link`</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
                <span class="c1"># prevent third party sequence_generators from ruining our party</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">hook_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>

            <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span>
            <span class="p">)</span>
            <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
            <span class="c1"># dont queue enquire_link in SimpleOutboundQueue since we dont want it to be behind 10k msgs etc</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">full_pdu</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enquire_link_interval</span><span class="p">)</span></div>

<div class="viewcode-block" id="Client.enquire_link_resp"><a class="viewcode-back" href="../../client.html#naz.client.Client.enquire_link_resp">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">enquire_link_resp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an ENQUIRE_LINK_RESP pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">sequence_number</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>

        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="n">item_to_enqueue</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">naz_message_protocol_version</span><span class="p">,</span>
            <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
            <span class="s2">&quot;pdu&quot;</span><span class="p">:</span> <span class="n">full_pdu</span><span class="p">,</span>
            <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">outboundqueue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">item_to_enqueue</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link_resp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.enquire_link_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.unbind_resp"><a class="viewcode-back" href="../../client.html#naz.client.Client.unbind_resp">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">unbind_resp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an UNBIND_RESP pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">sequence_number</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>

        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="c1"># dont queue unbind_resp in SimpleOutboundQueue since we dont want it to be behind 10k msgs etc</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.deliver_sm_resp"><a class="viewcode-back" href="../../client.html#naz.client.Client.deliver_sm_resp">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">deliver_sm_resp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send a DELIVER_SM_RESP pdu to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM_RESP</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.deliver_sm_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">body</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">sequence_number</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>

        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="n">item_to_enqueue</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">naz_message_protocol_version</span><span class="p">,</span>
            <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
            <span class="s2">&quot;pdu&quot;</span><span class="p">:</span> <span class="n">full_pdu</span><span class="p">,</span>
            <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">outboundqueue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">item_to_enqueue</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.deliver_sm_resp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.deliver_sm_resp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

    <span class="c1"># this method just enqueues a submit_sm msg to queue</span>
<div class="viewcode-block" id="Client.submit_sm"><a class="viewcode-back" href="../../client.html#naz.client.Client.submit_sm">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">submit_sm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">short_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source_addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">destination_addr</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        enqueues a SUBMIT_SM pdu to :attr:`outboundqueue &lt;Client.outboundqueue&gt;`</span>
<span class="sd">        That PDU will later on be sent to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            short_message: message to send to SMSC</span>
<span class="sd">            log_id: a unique identify of this request</span>
<span class="sd">            source_addr: the identifier(eg msisdn) of the message sender</span>
<span class="sd">            destination_addr: the identifier(eg msisdn) of the message recipient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># HEADER::</span>
        <span class="c1"># submit_sm has the following pdu header:</span>
        <span class="c1"># command_length, int, 4octet</span>
        <span class="c1"># command_id, int, 4octet. `submit_sm`</span>
        <span class="c1"># command_status, int, 4octet. Not used. Set to NULL</span>
        <span class="c1"># sequence_number, int, 4octet.  The associated submit_sm_resp PDU will echo this sequence number.</span>

        <span class="c1"># BODY::</span>
        <span class="c1"># submit_sm has the following pdu body. NB: They SHOULD be put in the body in the ORDER presented here.</span>
        <span class="c1"># service_type, c-octet str, max 6octet. eg NULL, &quot;USSD&quot;, &quot;CMT&quot; etc</span>
        <span class="c1"># source_addr_ton, int , 1octet,</span>
        <span class="c1"># source_addr_npi, int, 1octet</span>
        <span class="c1"># source_addr, c-octet str, max 21octet. eg; This is usually the senders phone Number</span>
        <span class="c1"># dest_addr_ton, int, 1octet</span>
        <span class="c1"># dest_addr_npi, int, 1octet</span>
        <span class="c1"># destination_addr,  C-Octet String, max 21 octet. eg; This is usually the recipients phone Number</span>
        <span class="c1"># esm_class, int, 1octet</span>
        <span class="c1"># protocol_id, int, 1octet</span>
        <span class="c1"># priority_flag, int, 1octet</span>
        <span class="c1"># schedule_delivery_time, c-octet str, 1 or 17 octets. NULL for immediate message delivery.</span>
        <span class="c1"># validity_period, c-octet str, 1 or 17 octets.  NULL for SMSC default.</span>
        <span class="c1"># registered_delivery, int, 1octet</span>
        <span class="c1"># replace_if_present_flag, int, 1octet</span>
        <span class="c1"># data_coding, int, 1octet. Defines the encoding scheme of the short message user data. Bits 7 6 5 4 3 2 1 0</span>
        <span class="c1"># sm_default_msg_id, int, 1octet. SMSC index of a pre-defined(`canned`) message.  If not using an SMSC canned message, set to NULL</span>
        <span class="c1"># sm_length, int, 1octet. Length in octets of the `short_message`.</span>
        <span class="c1"># short_message, Octet-String(NOT c-octet str), 0-254 octets.</span>
        <span class="c1"># NB: 1. Applications which need to send messages longer than 254 octets should use the `message_payload` optional parameter.</span>
        <span class="c1">#        In this case the `sm_length` field should be set to zero</span>
        <span class="c1">#        u cant use both `short_message` and `message_payload`</span>
        <span class="c1">#     2. Octet String - A series of octets, not necessarily NULL terminated.</span>

        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.submit_sm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">item_to_enqueue</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">naz_message_protocol_version</span><span class="p">,</span>
            <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">short_message</span><span class="p">,</span>
            <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
            <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">source_addr</span><span class="p">,</span>
            <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">destination_addr</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">outboundqueue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">item_to_enqueue</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.submit_sm&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.submit_sm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.build_submit_sm_pdu"><a class="viewcode-back" href="../../client.html#naz.client.Client.build_submit_sm_pdu">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">build_submit_sm_pdu</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">short_message</span><span class="p">,</span> <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span><span class="p">,</span> <span class="n">source_addr</span><span class="p">,</span> <span class="n">destination_addr</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        builds a SUBMIT_SM pdu.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            short_message: message to send to SMSC</span>
<span class="sd">            log_id: a unique identify of this request</span>
<span class="sd">            hook_metadata: additional metadata that you would like to be passed on to hooks</span>
<span class="sd">            source_addr: the identifier(eg msisdn) of the message sender</span>
<span class="sd">            destination_addr: the identifier(eg msisdn) of the message recipient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.build_submit_sm_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">encoded_short_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="n">short_message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span>
        <span class="p">)</span>
        <span class="n">sm_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoded_short_message</span><span class="p">)</span>

        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">body</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">service_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_addr_ton</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_addr_npi</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">source_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_addr_ton</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest_addr_npi</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">destination_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">esm_class</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">priority_flag</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">schedule_delivery_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validity_period</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">registered_delivery</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_if_present_flag</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_coding</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sm_default_msg_id</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">sm_length</span><span class="p">)</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">short_message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="c1"># the status for success see section 5.1.3</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># not used for `submit_sm`</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.build_submit_sm_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
            <span class="c1"># prevent third party sequence_generators from ruining our party</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.build_submit_sm_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>
        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.build_submit_sm_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;short_message&quot;</span><span class="p">:</span> <span class="n">short_message</span><span class="p">,</span>
                <span class="s2">&quot;source_addr&quot;</span><span class="p">:</span> <span class="n">source_addr</span><span class="p">,</span>
                <span class="s2">&quot;destination_addr&quot;</span><span class="p">:</span> <span class="n">destination_addr</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">full_pdu</span></div>

<div class="viewcode-block" id="Client.send_data"><a class="viewcode-back" href="../../client.html#naz.client.Client.send_data">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">smpp_command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hook_metadata</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends PDU&#39;s to SMSC through/over a network connection(down the wire).</span>
<span class="sd">        This method does not block; it buffers the data and arranges for it to be sent out asynchronously.</span>
<span class="sd">        It also accts as a flow control method that interacts with the IO write buffer.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            smpp_command: type of PDU been sent. eg bind_transceiver</span>
<span class="sd">            msg: PDU to be sent to SMSC over the network connection.</span>
<span class="sd">            log_id: a unique identify of this request</span>
<span class="sd">            hook_metadata: additional metadata that you would like to be passed on to hooks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># todo: look at `set_write_buffer_limits` and `get_write_buffer_limits` methods</span>
        <span class="c1"># print(&quot;get_write_buffer_limits:&quot;, writer.transport.get_write_buffer_limits())</span>

        <span class="n">log_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>
            <span class="c1"># do not log password, redact it from logs.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="ow">in</span> <span class="n">log_msg</span><span class="p">:</span>
                <span class="n">log_msg</span> <span class="o">=</span> <span class="n">log_msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{REDACTED}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># check session state to see if we can send messages.</span>
        <span class="c1"># see section 2.3 of SMPP spec document v3.4</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">==</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">CLOSED</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;smpp_command: </span><span class="si">{0}</span><span class="s2"> cannot be sent to SMSC when the client session state is: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
                    <span class="s2">&quot;current_session_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">==</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">OPEN</span> <span class="ow">and</span> <span class="n">smpp_command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;bind_transmitter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bind_receiver&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bind_transceiver&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="c1"># only the smpp_command&#39;s listed above are allowed by SMPP spec to be sent</span>
            <span class="c1"># if current_session_state == SmppSessionState.OPEN</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;smpp_command: </span><span class="si">{0}</span><span class="s2"> cannot be sent to SMSC when the client session state is: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
                    <span class="s2">&quot;current_session_state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span><span class="p">)</span>

        <span class="c1"># call user&#39;s hook for requests</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;request hook error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># We use writer.drain() which is a flow control method that interacts with the IO write buffer.</span>
        <span class="c1"># When the size of the buffer reaches the high watermark,</span>
        <span class="c1"># drain blocks until the size of the buffer is drained down to the low watermark and writing can be resumed.</span>
        <span class="c1"># When there is nothing to wait for, the drain() returns immediately.</span>
        <span class="c1"># ref: https://docs.python.org/3/library/asyncio-stream.html#asyncio.StreamWriter.drain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">log_msg</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.send_forever"><a class="viewcode-back" href="../../client.html#naz.client.Client.send_forever">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_forever</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In loop; dequeues items from the :attr:`outboundqueue &lt;Client.outboundqueue&gt;` and sends them to SMSC.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TESTING: indicates whether this method is been called while running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>

            <span class="c1"># TODO: there are so many try-except classes in this func.</span>
            <span class="c1"># do something about that.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># check with throttle handler</span>
                <span class="n">send_request</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">allow_request</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;send_forever error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">send_request</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># rate limit ourselves</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">rateLimiter</span><span class="o">.</span><span class="n">limit</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;send_forever error&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">item_to_dequeue</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">outboundqueue</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">poll_queue_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_after</span><span class="p">(</span><span class="n">retry_count</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;send_forever error. sleeping for </span><span class="si">{0}</span><span class="s2">minutes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">poll_queue_interval</span> <span class="o">/</span> <span class="mi">60</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="n">retry_count</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_queue_interval</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># we didn&#39;t fail to dequeue a message</span>
                <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log_id</span> <span class="o">=</span> <span class="n">item_to_dequeue</span><span class="p">[</span><span class="s2">&quot;log_id&quot;</span><span class="p">]</span>
                    <span class="n">item_to_dequeue</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>  <span class="c1"># version is a required field</span>
                    <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">item_to_dequeue</span><span class="p">[</span><span class="s2">&quot;smpp_command&quot;</span><span class="p">]</span>
                    <span class="n">hook_metadata</span> <span class="o">=</span> <span class="n">item_to_dequeue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hook_metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span><span class="p">:</span>
                        <span class="n">short_message</span> <span class="o">=</span> <span class="n">item_to_dequeue</span><span class="p">[</span><span class="s2">&quot;short_message&quot;</span><span class="p">]</span>
                        <span class="n">source_addr</span> <span class="o">=</span> <span class="n">item_to_dequeue</span><span class="p">[</span><span class="s2">&quot;source_addr&quot;</span><span class="p">]</span>
                        <span class="n">destination_addr</span> <span class="o">=</span> <span class="n">item_to_dequeue</span><span class="p">[</span><span class="s2">&quot;destination_addr&quot;</span><span class="p">]</span>
                        <span class="n">full_pdu</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_submit_sm_pdu</span><span class="p">(</span>
                            <span class="n">short_message</span><span class="p">,</span> <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span><span class="p">,</span> <span class="n">source_addr</span><span class="p">,</span> <span class="n">destination_addr</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">item_to_dequeue</span><span class="p">[</span><span class="s2">&quot;pdu&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="s2">&quot;enqueued message/object is missing required field:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;send_forever error&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                        <span class="s2">&quot;send_request&quot;</span><span class="p">:</span> <span class="n">send_request</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                    <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                    <span class="k">return</span> <span class="n">item_to_dequeue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># throttle_handler didn&#39;t allow us to send request.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;send_request&quot;</span><span class="p">:</span> <span class="n">send_request</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">throttle_delay</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.send_forever&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;send_forever error&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                    <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;throttle_handler_denied_request&quot;</span><span class="p">:</span> <span class="s2">&quot;throttle_handler_denied_request&quot;</span><span class="p">}</span>
                <span class="k">continue</span></div>

<div class="viewcode-block" id="Client.receive_data"><a class="viewcode-back" href="../../client.html#naz.client.Client.receive_data">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">bytes</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In loop; read bytes from the network connected to SMSC and hand them over to the :func:`throparserttled &lt;Client.parse_response_pdu&gt;`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            TESTING: indicates whether this method is been called while running tests.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>
            <span class="c1"># todo: look at `pause_reading` and `resume_reading` methods</span>
            <span class="n">command_length_header_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">command_length_header_data</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">poll_read_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retry_after</span><span class="p">(</span><span class="n">retry_count</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;no data received from SMSC. sleeping for </span><span class="si">{0}</span><span class="s2">minutes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">poll_read_interval</span> <span class="o">/</span> <span class="mi">60</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="n">retry_count</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_read_interval</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># we didn&#39;t fail to read from SMSC</span>
                <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">total_pdu_length</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">command_length_header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">MSGLEN</span> <span class="o">=</span> <span class="n">total_pdu_length</span> <span class="o">-</span> <span class="mi">4</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bytes_recd</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">bytes_recd</span> <span class="o">&lt;</span> <span class="n">MSGLEN</span><span class="p">:</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">MSGLEN</span> <span class="o">-</span> <span class="n">bytes_recd</span><span class="p">,</span> <span class="mi">2048</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;socket connection broken&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;socket connection broken&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">bytes_recd</span> <span class="o">=</span> <span class="n">bytes_recd</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">full_pdu_data</span> <span class="o">=</span> <span class="n">command_length_header_data</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_response_pdu</span><span class="p">(</span><span class="n">full_pdu_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.receive_data&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">TESTING</span><span class="p">:</span>
                <span class="c1"># offer escape hatch for tests to come out of endless loop</span>
                <span class="k">return</span> <span class="n">full_pdu_data</span></div>

<div class="viewcode-block" id="Client.parse_response_pdu"><a class="viewcode-back" href="../../client.html#naz.client.Client.parse_response_pdu">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_response_pdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdu</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take the bytes that have been read from network and parse them into their corresponding PDU.</span>
<span class="sd">        The resulting PDU is then handed over to :func:`speficic_handlers &lt;Client.speficic_handlers&gt;`</span>

<span class="sd">        Parameters:</span>
<span class="sd">            pdu: PDU in bytes, that have been read from network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.parse_response_pdu&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">})</span>

        <span class="n">header_data</span> <span class="o">=</span> <span class="n">pdu</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>
        <span class="n">body_data</span> <span class="o">=</span> <span class="n">pdu</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
        <span class="n">command_id_header_data</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">command_status_header_data</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span>
        <span class="n">sequence_number_header_data</span> <span class="o">=</span> <span class="n">header_data</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>

        <span class="n">command_id</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">command_id_header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">command_status_header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sequence_number</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;I&quot;</span><span class="p">,</span> <span class="n">sequence_number_header_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">smpp_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_by_command_id_code</span><span class="p">(</span><span class="n">command_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">smpp_command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.parse_response_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;command_id:</span><span class="si">{0}</span><span class="s2"> is unknown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command_id</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;command_id:</span><span class="si">{0}</span><span class="s2"> is unknown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command_id</span><span class="p">))</span>

        <span class="c1"># get associated user supplied log_id if any</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.parse_response_pdu&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater get error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">speficic_handlers</span><span class="p">(</span>
            <span class="n">body_data</span><span class="o">=</span><span class="n">body_data</span><span class="p">,</span>
            <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
            <span class="n">command_status_value</span><span class="o">=</span><span class="n">command_status</span><span class="p">,</span>
            <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
            <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
            <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.parse_response_pdu&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">command_status</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Client.speficic_handlers"><a class="viewcode-back" href="../../client.html#naz.client.Client.speficic_handlers">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">speficic_handlers</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">body_data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
        <span class="n">smpp_command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">command_status_value</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sequence_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">log_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">hook_metadata</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This routes the various different SMPP PDU to their respective handlers.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            body_data: PDU body</span>
<span class="sd">            smpp_command: type of PDU been sent. eg bind_transceiver</span>
<span class="sd">            command_status_value: the response code from SMSC for a specific PDU</span>
<span class="sd">            sequence_number: SMPP sequence_number</span>
<span class="sd">            log_id: a unique identify of this request</span>
<span class="sd">            hook_metadata: additional metadata that you would like to be passed on to hooks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">commandStatus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_by_command_status_value</span><span class="p">(</span>
            <span class="n">command_status_value</span><span class="o">=</span><span class="n">command_status_value</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">commandStatus</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;command_status:</span><span class="si">{0}</span><span class="s2"> is unknown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command_status_value</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="c1"># we got an error from SMSC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># call throttling handler</span>
            <span class="k">if</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">not_throttled</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_RTHROTTLED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">throttle_handler</span><span class="o">.</span><span class="n">throttled</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">smpp_command</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND_RESP</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM</span><span class="p">,</span>  <span class="c1"># We dont expect SMSC to send `submit_sm` to us.</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM_RESP</span><span class="p">,</span>
            <span class="c1"># we will never send a deliver_sm request to SMSC, which means we never</span>
            <span class="c1"># have to handle deliver_sm_resp</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK_RESP</span><span class="p">,</span>
            <span class="n">SmppCommand</span><span class="o">.</span><span class="n">GENERIC_NACK</span><span class="p">,</span>  <span class="c1"># we can ignore this</span>
        <span class="p">]:</span>
            <span class="c1"># we never have to handle this</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">BIND_TRANSCEIVER_RESP</span><span class="p">:</span>
            <span class="c1"># the body of `bind_transceiver_resp` only has `system_id` which is a</span>
            <span class="c1"># C-Octet String of variable length upto 16 octets</span>
            <span class="k">if</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">SmppCommandStatus</span><span class="o">.</span><span class="n">ESME_ROK</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_session_state</span> <span class="o">=</span> <span class="n">SmppSessionState</span><span class="o">.</span><span class="n">BOUND_TRX</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND</span><span class="p">:</span>
            <span class="c1"># we need to handle this since we need to send unbind_resp</span>
            <span class="c1"># it has no body</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">unbind_resp</span><span class="p">(</span><span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">SUBMIT_SM_RESP</span><span class="p">:</span>
            <span class="c1"># the body of this only has `message_id` which is a C-Octet String of variable length upto 65 octets.</span>
            <span class="c1"># This field contains the SMSC message_id of the submitted message.</span>
            <span class="c1"># It may be used at a later stage to query the status of a message, cancel</span>
            <span class="c1"># or replace the message.</span>
            <span class="n">smsc_message_id</span> <span class="o">=</span> <span class="n">body_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">smsc_message_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                <span class="n">smsc_message_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                    <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                    <span class="n">smsc_message_id</span><span class="o">=</span><span class="n">smsc_message_id</span><span class="p">,</span>
                    <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                    <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">DELIVER_SM</span><span class="p">:</span>
            <span class="c1"># HEADER::</span>
            <span class="c1"># command_length, int, 4octet</span>
            <span class="c1"># command_id, int, 4octet. `deliver_sm`</span>
            <span class="c1"># command_status, int, 4octet. Unused, Set to NULL.</span>
            <span class="c1"># sequence_number, int, 4octet. The associated `deliver_sm_resp` PDU should echo the same sequence_number.</span>

            <span class="c1"># BODY::</span>
            <span class="c1"># see section 4.6.1 of smpp v3.4 spec</span>
            <span class="c1"># we want to handle this pdu, bcoz we are expected to send back deliver_sm_resp</span>
            <span class="c1"># the body of this has the following params</span>
            <span class="c1"># service_type, C-Octet String, max 6 octets</span>
            <span class="c1"># source_addr_ton, Int, 1 octet, can be NULL</span>
            <span class="c1"># source_addr_npi, Int, 1 octet, can be NULL</span>
            <span class="c1"># source_addr, C-Octet String, max 21 octet, can be NULL</span>
            <span class="c1"># dest_addr_ton, Int, 1 octet</span>
            <span class="c1"># dest_addr_npi, Int, 1 octet</span>
            <span class="c1"># destination_addr,  C-Octet String, max 21 octet</span>
            <span class="c1"># esm_class, Int, 1 octet</span>
            <span class="c1"># protocol_id, Int, 1 octet</span>
            <span class="c1"># priority_flag, Int, 1 octet</span>
            <span class="c1"># schedule_delivery_time, C-Octet String, 1 octet, must be set to NULL.</span>
            <span class="c1"># validity_period, C-Octet String, 1 octet, must be set to NULL.</span>
            <span class="c1"># registered_delivery, Int, 1 octet</span>
            <span class="c1"># replace_if_present_flag, Int, 1 octet, must be set to NULL.</span>
            <span class="c1"># data_coding, Int, 1 octet</span>
            <span class="c1"># sm_default_msg_id, Int, 1 octet, must be set to NULL.</span>
            <span class="c1"># sm_length, Int, 1 octet.It is length of short message user data in octets.</span>
            <span class="c1"># short_message, C-Octet String, 0-254 octet</span>

            <span class="c1"># NB: user&#39;s hook has already been called.</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">deliver_sm_resp</span><span class="p">(</span><span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get associated user supplied log_id if any</span>
                <span class="n">target_tag</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;H&quot;</span><span class="p">,</span> <span class="n">SmppOptionalTag</span><span class="o">.</span><span class="n">receipted_message_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target_tag</span> <span class="ow">in</span> <span class="n">body_data</span><span class="p">:</span>
                    <span class="c1"># the PDU contains a `receipted_message_id` TLV optional tag</span>
                    <span class="n">position_of_target_tag</span> <span class="o">=</span> <span class="n">body_data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">target_tag</span><span class="p">)</span>
                    <span class="c1"># since a tag is 2 integer in size lets skip one more.</span>
                    <span class="n">end_of_target_tag</span> <span class="o">=</span> <span class="n">position_of_target_tag</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="c1"># since after a tag, comes a tag_length which is 2 integer in size</span>
                    <span class="c1"># lets also skip that</span>
                    <span class="n">end_of_target_tag_length</span> <span class="o">=</span> <span class="n">end_of_target_tag</span> <span class="o">+</span> <span class="mi">2</span>
                    <span class="n">end_of_target_tag_length</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">end_of_target_tag_length</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>  <span class="c1"># because of c-octet string null termination</span>
                    <span class="c1"># tag_value is of size 1 - 65</span>
                    <span class="n">end_of_tag_value</span> <span class="o">=</span> <span class="n">end_of_target_tag_length</span> <span class="o">+</span> <span class="mi">65</span>
                    <span class="n">tag_value</span> <span class="o">=</span> <span class="n">body_data</span><span class="p">[</span><span class="n">end_of_target_tag_length</span><span class="p">:</span><span class="n">end_of_tag_value</span><span class="p">]</span>
                    <span class="n">tag_value</span> <span class="o">=</span> <span class="n">tag_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">tag_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_class</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                        <span class="n">tag_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec_errors_level</span>
                    <span class="p">)</span>
                    <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                        <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                        <span class="n">smsc_message_id</span><span class="o">=</span><span class="n">tag_value</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log_id</span><span class="p">,</span> <span class="n">hook_metadata</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater get error&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">smpp_command</span> <span class="o">==</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">ENQUIRE_LINK</span><span class="p">:</span>
            <span class="c1"># we have to handle this. we have to return enquire_link_resp</span>
            <span class="c1"># it has no body</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enquire_link_resp</span><span class="p">(</span><span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;command_status&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">commandStatus</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;the smpp_command:</span><span class="si">{0}</span><span class="s2"> has not been implemented in naz. please create a github issue&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">smpp_command</span>
                    <span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># call user&#39;s hook for responses</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">response</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="n">hook_metadata</span><span class="p">,</span>
                <span class="n">smsc_response</span><span class="o">=</span><span class="n">commandStatus</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.speficic_handlers&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;response hook error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Client.unbind"><a class="viewcode-back" href="../../client.html#naz.client.Client.unbind">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">unbind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        send an UNBIND pdu to SMSC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">smpp_command</span> <span class="o">=</span> <span class="n">SmppCommand</span><span class="o">.</span><span class="n">UNBIND</span>
        <span class="n">log_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">17</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># body</span>
        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

        <span class="c1"># header</span>
        <span class="n">command_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>  <span class="c1"># 16 is for headers</span>
        <span class="n">command_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_ids</span><span class="p">[</span><span class="n">smpp_command</span><span class="p">]</span>
        <span class="n">command_status</span> <span class="o">=</span> <span class="mh">0x00000000</span>  <span class="c1"># not used for `unbind`</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sequence_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequence_generator</span><span class="o">.</span><span class="n">next_sequence</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">sequence_number</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span><span class="p">:</span>
            <span class="c1"># prevent third party sequence_generators from ruining our party</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;the sequence_number: </span><span class="si">{0}</span><span class="s2"> is greater than the max: </span><span class="si">{1}</span><span class="s2"> allowed by SMPP spec.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sequence_number</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sequence_number</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">correlation_handler</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span>
                <span class="n">sequence_number</span><span class="o">=</span><span class="n">sequence_number</span><span class="p">,</span>
                <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">,</span>
                <span class="n">hook_metadata</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
                    <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;correlater put error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;IIII&quot;</span><span class="p">,</span> <span class="n">command_length</span><span class="p">,</span> <span class="n">command_id</span><span class="p">,</span> <span class="n">command_status</span><span class="p">,</span> <span class="n">sequence_number</span><span class="p">)</span>
        <span class="n">full_pdu</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">body</span>
        <span class="c1"># dont queue unbind in SimpleOutboundQueue since we dont want it to be behind 10k msgs etc</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">smpp_command</span><span class="o">=</span><span class="n">smpp_command</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">full_pdu</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="p">(</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;event&quot;</span><span class="p">:</span> <span class="s2">&quot;naz.Client.unbind&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;log_id&quot;</span><span class="p">:</span> <span class="n">log_id</span><span class="p">,</span>
                <span class="s2">&quot;smpp_command&quot;</span><span class="p">:</span> <span class="n">smpp_command</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">naz</a></h1>



<p class="blurb">naz is an async SMPP client.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=komuw&repo=naz&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>







    

<p>
<a class="badge" href="https://codecov.io/github/komuw/naz">
    <img
    alt="https://codecov.io/github/komuw/naz/coverage.svg?branch=master"
    src="https://codecov.io/github/komuw/naz/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction to naz</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../correlater.html">correlater</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hooks.html">hooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nazcodec.html">nazcodec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../queue.html">queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ratelimiter.html">ratelimiter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sequence.html">sequence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../throttle.html">throttle</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../state.html">state</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logger.html">logger</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Komu Wairagu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>